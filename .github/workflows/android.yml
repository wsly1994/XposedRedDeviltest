name: Android CI

on: [push, pull_request]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Set up JDK 11
      uses: actions/setup-java@v4
      with:
        java-version: '11'
        distribution: 'temurin'
        cache: gradle

    - name: Grant execute permission for gradlew
      run: chmod +x gradlew

    # 1. ç°åœºç”Ÿæˆé€šç”¨è¯ä¹¦ (è¿™å°±ç›¸å½“äºä¹°äº†æŠŠæ–°é”)
    - name: Generate Debug Keystore
      run: |
        mkdir -p ~/.android
        keytool -genkey -v -keystore ~/.android/debug.keystore -alias androiddebugkey -keyalg RSA -keysize 2048 -validity 10000 -storepass android -keypass android -dname "CN=Android Debug,O=Android,C=US"

    # 2. ğŸ”¥ å½»åº•æ¸…æ´—ï¼šåˆ é™¤æ‰€æœ‰æ—§å¯†ç ã€æ—§åˆ«åã€æ—§é…ç½®
    # åªè¦è¿™å‡ è¡Œåˆ å¹²å‡€äº†ï¼ŒGradle å°±åªèƒ½ç”¨ä¸Šé¢çš„é»˜è®¤è¯ä¹¦ï¼Œç»æ— æŠ¥é”™å¯èƒ½ï¼
    - name: Nuke Signing Configs
      run: |
        sed -i '/signingConfig/d' app/build.gradle
        sed -i '/storeFile/d' app/build.gradle
        sed -i '/storePassword/d' app/build.gradle
        sed -i '/keyAlias/d' app/build.gradle
        sed -i '/keyPassword/d' app/build.gradle

    - name: Build with Gradle (Debug Mode)
      run: ./gradlew assembleDebug -x lint

    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: app-debug
        path: app/build/outputs/apk/debug/*.apk
