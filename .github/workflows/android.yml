name: Android CI

on: [push, pull_request]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Set up JDK 11
      uses: actions/setup-java@v4
      with:
        java-version: '11'
        distribution: 'temurin'
        cache: gradle

    - name: Grant execute permission for gradlew
      run: chmod +x gradlew

    # ğŸ”¥ ç¬¬ä¸€æ­¥ï¼šç°åœºé€ ä¸€æŠŠé€šç”¨çš„â€œå‡é’¥åŒ™â€
    # æ³¨æ„ï¼šæˆ‘æŠŠå®ƒç›´æ¥æ”¾åœ¨ app ç›®å½•ä¸‹ï¼Œæ–¹ä¾¿ä¸‹é¢è°ƒç”¨
    - name: Generate Debug Keystore
      run: |
        keytool -genkey -v -keystore app/debug.keystore -alias androiddebugkey -keyalg RSA -keysize 2048 -validity 10000 -storepass android -keypass android -dname "CN=Android Debug,O=Android,C=US"

    # ğŸ”¥ ç¬¬äºŒæ­¥ï¼šå·æ¢æ¢æŸ±ï¼ˆå…³é”®ä¿®å¤ï¼ï¼‰
    # æˆ‘ä»¬ä¸åˆ é™¤ä»»ä½•è¡Œï¼ˆé˜²æ­¢ç ´åèŠ±æ‹¬å·ï¼‰ï¼Œè€Œæ˜¯æŠŠåŸä½œè€…çš„é…ç½®â€œæ›¿æ¢â€æˆæˆ‘ä»¬çš„
    # è¿™æ ·ä»£ç ç»“æ„å®Œå…¨ä¸å˜ï¼Œä½†å†…å®¹å˜æˆäº†æˆ‘ä»¬åˆšç”Ÿæˆçš„è¿™æŠŠé’¥åŒ™
    - name: Hijack Signing Config
      run: |
        sed -i 's/storeFile file.*/storeFile file("debug.keystore")/g' app/build.gradle
        sed -i 's/storePassword.*/storePassword "android"/g' app/build.gradle
        sed -i 's/keyAlias.*/keyAlias "androiddebugkey"/g' app/build.gradle
        sed -i 's/keyPassword.*/keyPassword "android"/g' app/build.gradle

    - name: Build with Gradle (Debug Mode)
      run: ./gradlew assembleDebug -x lint

    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: app-debug
        path: app/build/outputs/apk/debug/*.apk
